{
  "hash": "23441368549ca8d47682acfb90d58948",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: MQTT\necho: false\nexecute:\n  freeze: auto\n---\n\n<!-- ---\ntitle: \"\"\necho: false\njupyter: python3\nsection-divs: false\n--- -->\n\n\n\n![](https://mqtt.org/assets/downloads/mqtt-logo.png)\n\n## Intro\nIn today's session, we will be diving into the fascinating world of MQTT and its relevance in the field of agriculture. MQTT, which stands for Message Queuing Telemetry Transport, is a lightweight and efficient messaging protocol designed for constrained devices and low-bandwidth networks.\n\nIn the realm of AgroTech, where the Internet of Things (IoT) plays a crucial role, MQTT offers a powerful solution for connecting sensors, actuators, and other devices in agricultural systems. It provides a reliable and scalable means of communication, enabling seamless data exchange between devices, networks, and applications.\n\nOne of the primary advantages of MQTT is its lightweight nature, making it ideal for resource-constrained devices such as the ESP32 microcontroller. With its small code footprint and minimal network overhead, MQTT facilitates efficient data transmission even in remote or challenging agricultural environments.\n\nThrough the use of MQTT, farmers and agriculturalists can gather real-time information about various aspects of their operations, including temperature, humidity, soil moisture, and crop health. This data can then be transmitted to centralized servers or cloud platforms, allowing for intelligent analysis, decision-making, and automation in the agricultural domain.\n\nFurthermore, MQTT follows a publish-subscribe messaging pattern, enabling a scalable and flexible communication model. Devices can publish data to specific topics, and other devices or applications can subscribe to these topics to receive relevant information. This decoupled architecture ensures that data is delivered only to those who need it, minimizing network congestion and optimizing system performance.\n\nIn this AgroTech class, we will explore the implementation of MQTT on the ESP32 microcontroller, enabling you to build innovative and efficient solutions for the agricultural sector. So, let's dive in and discover how MQTT can revolutionize the way we approach farming, enhance productivity, and contribute to sustainable agriculture practices.\n\n## Fundamental Concepts\n\n1. **MQTT Broker:**  \nAt the core of MQTT is the broker, which acts as a central hub for message exchange. The broker receives messages published by clients and distributes them to the interested subscribers. It is responsible for routing messages based on topics and maintaining the overall communication flow.\n**For our calss today we will use the [Hivemq free public broker](https://www.hivemq.com/public-mqtt-broker/)**.\n\n1. **MQTT Client:**  \nClients are devices or applications that connect to the MQTT broker. They can be sensors, actuators, microcontrollers, or any device capable of sending or receiving messages. MQTT clients can function as both publishers and subscribers, allowing them to send data and receive updates from the broker. **For our class we can utilize the [Hivemq online client](https://www.hivemq.com/demos/websocket-client/) for testing**.\n\n1. **Topic:**  \nTopics are hierarchical strings that act as labels for messages. They serve as a way to categorize and organize information. When publishing a message, clients assign it to a specific topic. Subscribers can then choose to receive messages from specific topics of interest. For example, in agriculture, topics could represent sensor data such as \"temperature,\" \"humidity,\" or \"soil moisture.\"\n\n1. **Publish:**  \nPublishing refers to the action of sending a message from an MQTT client to the broker. When a client publishes a message, it specifies the topic to which the message belongs. The broker then distributes the message to all the interested subscribers that have subscribed to that particular topic.\n\n1. **Subscribe:**  \nSubscribing allows clients to express their interest in receiving messages from specific topics. By subscribing to a topic, a client informs the broker that it wants to receive messages published to that topic. Subscriptions can be specific to a particular topic (e.g., `temperature`) or can use wildcard characters to subscribe to multiple topics (e.g., `agriculture/+/moisture` to subscribe to all moisture data in different areas of agriculture).\n\n## A bit more about topics\nTopics in MQTT are written as hierarchical strings, consisting of one or more levels separated by forward slashes (`/`). Each level within a topic provides a level of categorization and organization for the messages.\n\nFor example, consider the topic structure in agriculture:\n\n* `agriculture/temperature`: This topic represents the temperature data in the agricultural context. It consists of a single level, `agriculture` followed by another level, `temperature`.\n\n* `agriculture/field1/humidity`: This topic represents the humidity data in a specific field. It consists of three levels: `agriculture`, `field1`, and `humidity`.\n\n* `agriculture/+/soil moisture`: This topic uses a wildcard character, `+`, which can match exactly one topic level. Subscribing to this topic would allow receiving messages related to soil moisture from various areas within agriculture.\n\n* `agriculture/#`: This topic uses the wildcard character `#`, which can match multiple levels or no level at all. Subscribing to this topic would enable receiving messages from any sub-topic under `agriculture`.\n\nThe use of forward slashes and levels in topic design allows for a structured approach to organizing data in MQTT. It enables subscribers to select specific levels or use wildcard characters to filter and receive messages of interest.\n\nWhen publishing a message, the client specifies the topic to which the message belongs, ensuring that it is appropriately categorized and can be received by subscribers who are interested in that specific topic.\n\nUnderstanding how topics are written and structured is crucial for effective message routing and data organization within MQTT-based AgroTech applications.\n\n## LED subscribe\n\n```{=html}\n<button class=\"btn btn-outline-dark  rounded\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#MQTT_led_subscribeino\" aria-expanded=\"false\" aria-controls=\"MQTT_led_subscribeino\">\n    <i class=\"bi bi-toggles\"></i> Toggle code\n    </button>\n     <a class=\"btn btn-outline-dark rounded\", href=\"/archive/code/MQTT_led_subscribe.ino\" download target=\"_blank\" rel=\"noopener noreferrer\">\n        <i class=\"bi bi-download\"></i> Download code\n    </a>\n```\n```{=html}\n\n            <div class=\"collapse\" id=\"MQTT_led_subscribeino\">\n            <div class=\"card card-body border-0\">\n        \n```\n```{.c code-line-numbers=\"1\"}\n//addapted from:\n//https://microcontrollerslab.com/esp32-mqtt-client-publish-subscribe-bme280-readings-hivemq/\n\n#include <Arduino.h>\n#include <WiFi.h>\n#include <PubSubClient.h>\n\nWiFiClient wifiClient;\nPubSubClient mqttClient(wifiClient); \n\nconst char* ssid = \"wifi_name\";\nconst char* password = \"wifi_password\";\n\nchar *mqttServer = \"broker.hivemq.com\";\nint mqttPort = 1883;\n\nint LED_pin = A4;\nString msgString; // Declare msgString variable in the global scope\n\nvoid setupMQTT() {\n  mqttClient.setServer(mqttServer, mqttPort);\n  mqttClient.setCallback(callback);\n}\n\nvoid reconnect() {\n  Serial.println(\"Connecting to MQTT Broker...\");\n  while (!mqttClient.connected()) {\n      Serial.println(\"Reconnecting to MQTT Broker..\");\n      String clientId = \"ESP32Client-\";\n      clientId += String(random(0xffff), HEX);\n      \n      if (mqttClient.connect(clientId.c_str())) {\n        Serial.println(\"Connected.\");\n        // subscribe to topic\n        mqttClient.subscribe(\"agrotech/mqtt_tutorial/LED\");\n      }      \n  }\n}\n\nvoid setup() {\n  Serial.begin(115200);\n  WiFi.begin(ssid, password);\n    while (WiFi.status() != WL_CONNECTED) {\n      delay(500);\n      Serial.print(\".\");\n    } \n    Serial.println(\"\");\n     Serial.println(\"Connected to Wi-Fi\");\n\n  setupMQTT();\n\n  pinMode(LED_pin, OUTPUT);\n  digitalWrite(LED_pin, LOW); \n  \n}\n\n\nvoid loop() {\n  if (!mqttClient.connected()) {\n      reconnect();\n  }\n    \n  mqttClient.loop();\n  long now = millis();\n}\n\n\n\nvoid callback(char* topic, byte* message, unsigned int length) {\n  // Convert byte array to string\n  msgString = String((char*)message, length);\n\n  // Convert string to integer\n  int ledState = msgString.toInt();\n\n  Serial.print(\"Message: \");\n  Serial.println(msgString);\n  Serial.print(\"LED State: \");\n  Serial.println(ledState);\n\n  if (ledState == 1) {\n    digitalWrite(LED_pin, HIGH);  // Set pin A4 high\n  } else if (ledState == 0) {\n    digitalWrite(LED_pin, LOW);   // Set pin A4 low\n  }\n}\n\n```\n\n```{=html}\n\n            </div>\n            </div>\n            \n```\n\n\n## Publish text\n\n```{=html}\n<button class=\"btn btn-outline-dark  rounded\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#agrotech_mqtt_publish_textino\" aria-expanded=\"false\" aria-controls=\"agrotech_mqtt_publish_textino\">\n    <i class=\"bi bi-toggles\"></i> Toggle code\n    </button>\n     <a class=\"btn btn-outline-dark rounded\", href=\"/archive/code/agrotech_mqtt_publish_text.ino\" download target=\"_blank\" rel=\"noopener noreferrer\">\n        <i class=\"bi bi-download\"></i> Download code\n    </a>\n```\n```{=html}\n\n            <div class=\"collapse\" id=\"agrotech_mqtt_publish_textino\">\n            <div class=\"card card-body border-0\">\n        \n```\n```{.c code-line-numbers=\"1\"}\n#include <Arduino.h>\n#include <WiFi.h>\n#include <PubSubClient.h>\n\nWiFiClient wifiClient;\nPubSubClient mqttClient(wifiClient); \n\nconst char* ssid = \"wifi_name\";\nconst char* password = \"wifi_password\";\n\nconst char* mqttServer = \"broker.hivemq.com\";\nint mqttPort = 1883;\n\nlong previous_time = 0;\nconst char* messageToSend = \"This is my fuuny message\"; // Message as a variable\n\nvoid setupMQTT() {\n  mqttClient.setServer(mqttServer, mqttPort);\n}\n\nvoid reconnect() {\n  Serial.println(\"Connecting to MQTT Broker...\");\n  while (!mqttClient.connected()) {\n    Serial.println(\"Reconnecting to MQTT Broker..\");\n    String clientId = \"ESP32Client-\";\n    clientId += String(random(0xffff), HEX);\n    \n    if (mqttClient.connect(clientId.c_str())) {\n      Serial.println(\"Connected.\");\n    }      \n  }\n}\n\nvoid setup() {\n  Serial.begin(115200);\n  WiFi.begin(ssid, password);\n  while (WiFi.status() != WL_CONNECTED) {\n    delay(500);\n    Serial.print(\".\");\n  } \n  Serial.println(\"\");\n  Serial.println(\"Connected to Wi-Fi\");\n\n  setupMQTT();\n}\n\nvoid loop() {\n  if (!mqttClient.connected())\n    reconnect();\n  mqttClient.loop();\n  long now = millis();\n\n  if (now - previous_time > 5000) {\n    previous_time = now;\n    mqttClient.publish(\"agrotech/mqtt_tutorial/message\", messageToSend);\n  }\n}\n\n```\n\n```{=html}\n\n            </div>\n            </div>\n            \n```\n\n\n## Sensor subscribe\n\n```{=html}\n<button class=\"btn btn-outline-dark  rounded\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#MQTT_sensor_subscribeino\" aria-expanded=\"false\" aria-controls=\"MQTT_sensor_subscribeino\">\n    <i class=\"bi bi-toggles\"></i> Toggle code\n    </button>\n     <a class=\"btn btn-outline-dark rounded\", href=\"/archive/code/MQTT_sensor_subscribe.ino\" download target=\"_blank\" rel=\"noopener noreferrer\">\n        <i class=\"bi bi-download\"></i> Download code\n    </a>\n```\n```{=html}\n\n            <div class=\"collapse\" id=\"MQTT_sensor_subscribeino\">\n            <div class=\"card card-body border-0\">\n        \n```\n```{.c code-line-numbers=\"1\"}\n//addapted from:\n//https://microcontrollerslab.com/esp32-mqtt-client-publish-subscribe-bme280-readings-hivemq/\n\n#include <Arduino.h>\n#include <WiFi.h>\n#include <PubSubClient.h>\n\nWiFiClient wifiClient;\nPubSubClient mqttClient(wifiClient); \n\nconst char* ssid = \"wifi_name\";\nconst char* password = \"wifi_password\";\n\nchar *mqttServer = \"broker.hivemq.com\";\nint mqttPort = 1883;\n\nfloat value = 0;\nString msgString; // Declare msgString variable in the global scope\n\nvoid setupMQTT() {\n  mqttClient.setServer(mqttServer, mqttPort);\n  mqttClient.setCallback(callback);\n}\n\nvoid reconnect() {\n  Serial.println(\"Connecting to MQTT Broker...\");\n  while (!mqttClient.connected()) {\n      Serial.println(\"Reconnecting to MQTT Broker..\");\n      String clientId = \"ESP32Client-\";\n      clientId += String(random(0xffff), HEX);\n      \n      if (mqttClient.connect(clientId.c_str())) {\n        Serial.println(\"Connected.\");\n        // subscribe to topic\n        mqttClient.subscribe(\"agrotech/mqtt_tutorial/temperature\");\n      }      \n  }\n}\n\nvoid setup() {\n  Serial.begin(115200);\n  WiFi.begin(ssid, password);\n    while (WiFi.status() != WL_CONNECTED) {\n      delay(500);\n      Serial.print(\".\");\n    } \n    Serial.println(\"\");\n     Serial.println(\"Connected to Wi-Fi\");\n\n  setupMQTT();\n\n}\n\n\nvoid loop() {\n  if (!mqttClient.connected()) {\n      reconnect();\n  }\n    \n  mqttClient.loop();\n  long now = millis();\n}\n\n\n\nvoid callback(char* topic, byte* message, unsigned int length) {\n  // Convert byte array to string\n  msgString = String((char*)message, length);\n\n  // Convert string to float\n  value = msgString.toFloat();\n\n  Serial.println(value);\n\n}\n\n```\n\n```{=html}\n\n            </div>\n            </div>\n            \n```\n\n\n## Publish and subscribe\n\n```{=html}\n<button class=\"btn btn-outline-dark  rounded\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#MQTT_publish_and_subscribeino\" aria-expanded=\"false\" aria-controls=\"MQTT_publish_and_subscribeino\">\n    <i class=\"bi bi-toggles\"></i> Toggle code\n    </button>\n     <a class=\"btn btn-outline-dark rounded\", href=\"/archive/code/MQTT_publish_and_subscribe.ino\" download target=\"_blank\" rel=\"noopener noreferrer\">\n        <i class=\"bi bi-download\"></i> Download code\n    </a>\n```\n```{=html}\n\n            <div class=\"collapse\" id=\"MQTT_publish_and_subscribeino\">\n            <div class=\"card card-body border-0\">\n        \n```\n```{.c code-line-numbers=\"1\"}\n//addapted from:\n//https://microcontrollerslab.com/esp32-mqtt-client-publish-subscribe-bme280-readings-hivemq/\n\n#include <Arduino.h>\n#include <WiFi.h>\n#include <PubSubClient.h>\n\nWiFiClient wifiClient;\nPubSubClient mqttClient(wifiClient); \n\nconst char* ssid = \"TP-Link_905D\";\nconst char* password = \"33072036\";\n\nchar *mqttServer = \"broker.hivemq.com\";\nint mqttPort = 1883;\n\nlong previous_time = 0;\nString msgString; // Declare msgString variable in the global scope\n\nvoid setupMQTT() {\n  mqttClient.setServer(mqttServer, mqttPort);\n  mqttClient.setCallback(callback);\n}\n\nvoid reconnect() {\n  Serial.println(\"Connecting to MQTT Broker...\");\n  while (!mqttClient.connected()) {\n      Serial.println(\"Reconnecting to MQTT Broker..\");\n      String clientId = \"ESP32Client-\";\n      clientId += String(random(0xffff), HEX);\n      \n      if (mqttClient.connect(clientId.c_str())) {\n        Serial.println(\"Connected.\");\n        // subscribe to topic\n        mqttClient.subscribe(\"agrotech/2023/message\");\n      }      \n  }\n}\n\nvoid setup() {\n  Serial.begin(115200);\n  WiFi.begin(ssid, password);\n    while (WiFi.status() != WL_CONNECTED) {\n      delay(500);\n      Serial.print(\".\");\n    } \n    Serial.println(\"\");\n     Serial.println(\"Connected to Wi-Fi\");\n\n  setupMQTT();\n}\n\n\nvoid loop() {\n  if (!mqttClient.connected())\n    reconnect();\n  mqttClient.loop();\n  long now = millis();\n\n  if (now - previous_time > 1000) {\n    previous_time = now;\n\n    float temperature = random(1, 101);\n    char tempString[8];\n    dtostrf(temperature, 1, 2, tempString);\n    Serial.print(\"Temperature: \");\n    Serial.println(tempString);\n    mqttClient.publish(\"agrotech/2023/temperature\", tempString);\n\n    mqttClient.publish(\"agrotech/2023/string\", \"Hi :)\");\n\n//    Serial.print(\"Subscribed Message: \");\n//    Serial.println(msgString);\n  }\n}\n\n\nvoid callback(char* topic, byte* message, unsigned int length) {\n  // Convert byte array to string\n //  String msgString((char*)message, length);\n\n  msgString = String((char*)message, length);\n  \n  // Convert string to float\n  float msgFloat = msgString.toFloat();\n\n  // Convert string to integer\n  int msgInt = msgString.toInt();\n  \n  Serial.print(\"Message: \");\n  Serial.println(msgString);\n  Serial.print(\"Float: \");\n  Serial.println(msgFloat);\n  Serial.print(\"Integer: \");\n  Serial.println(msgInt);\n}\n\n```\n\n```{=html}\n\n            </div>\n            </div>\n            \n```\n\n\n## MQTT + Python\n\n## Subscribe\n\n```{=html}\n<button class=\"btn btn-outline-dark  rounded\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#MQTT_python_subscribepy\" aria-expanded=\"false\" aria-controls=\"MQTT_python_subscribepy\">\n    <i class=\"bi bi-toggles\"></i> Toggle code\n    </button>\n     <a class=\"btn btn-outline-dark rounded\", href=\"/archive/code/MQTT_python_subscribe.py\" download target=\"_blank\" rel=\"noopener noreferrer\">\n        <i class=\"bi bi-download\"></i> Download code\n    </a>\n```\n```{=html}\n\n            <div class=\"collapse\" id=\"MQTT_python_subscribepy\">\n            <div class=\"card card-body border-0\">\n        \n```\n```{.python code-line-numbers=\"1\"}\nimport paho.mqtt.client as mqtt\n\n# MQTT broker details\nbroker_address = \"broker.hivemq.com\"\nbroker_port = 1883\n\n# Callback function when a connection is established with the MQTT broker\ndef on_connect(client, userdata, flags, rc):\n    print(\"Connected to MQTT broker with result code: \" + str(rc))\n    # Subscribe to the topic upon successful connection\n    client.subscribe(\"agrotech/mqtt_tutorial/#\")\n\n# Callback function when a message is received\ndef on_message(client, userdata, msg):\n    print(\"Received message: \" + str(msg.payload.decode()))\n\n# Create a MQTT client instance\nclient = mqtt.Client()\n\n# Assign callback functions\nclient.on_connect = on_connect\nclient.on_message = on_message\n\n# Connect to the MQTT broker\nclient.connect(broker_address, broker_port, 60)\n\n# Loop to maintain the connection and process network traffic\nclient.loop_forever()\n```\n\n```{=html}\n\n            </div>\n            </div>\n            \n```\n\n\n## Publish\n\n```{=html}\n<button class=\"btn btn-outline-dark  rounded\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#MQTT_python_publishpy\" aria-expanded=\"false\" aria-controls=\"MQTT_python_publishpy\">\n    <i class=\"bi bi-toggles\"></i> Toggle code\n    </button>\n     <a class=\"btn btn-outline-dark rounded\", href=\"/archive/code/MQTT_python_publish.py\" download target=\"_blank\" rel=\"noopener noreferrer\">\n        <i class=\"bi bi-download\"></i> Download code\n    </a>\n```\n```{=html}\n\n            <div class=\"collapse\" id=\"MQTT_python_publishpy\">\n            <div class=\"card card-body border-0\">\n        \n```\n```{.python code-line-numbers=\"1\"}\nimport paho.mqtt.client as mqtt\nimport random\nimport time\n\n# MQTT broker details\nbroker_address = \"broker.hivemq.com\"\nbroker_port = 1883\n\n# Create a MQTT client instance\nclient = mqtt.Client()\n\n# Connect to the MQTT broker\nclient.connect(broker_address, broker_port, 60)\n\ntemperature = 20.0\n# Loop to publish random temperature readings\nwhile True:\n    temperature = temperature + random.uniform(-1, 1)  # Generate a random temperature value between 20.0 and 30.0\n    client.publish(\"agrotech/mqtt_tutorial/temperature\", str(temperature))  # Publish the temperature value to the topic\n    print(\"Published temperature: \" + str(temperature))\n    time.sleep(1)  # Wait for 5 seconds before publishing the next temperature reading\n\n# Disconnect from the MQTT broker (not reached in this example)\nclient.disconnect()\n```\n\n```{=html}\n\n            </div>\n            </div>\n            \n```\n\n\n## Subscribe to CSV\n\n```{=html}\n<button class=\"btn btn-outline-dark  rounded\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#mqtt_to_csvpy\" aria-expanded=\"false\" aria-controls=\"mqtt_to_csvpy\">\n    <i class=\"bi bi-toggles\"></i> Toggle code\n    </button>\n     <a class=\"btn btn-outline-dark rounded\", href=\"/archive/code/mqtt_to_csv.py\" download target=\"_blank\" rel=\"noopener noreferrer\">\n        <i class=\"bi bi-download\"></i> Download code\n    </a>\n```\n```{=html}\n\n            <div class=\"collapse\" id=\"mqtt_to_csvpy\">\n            <div class=\"card card-body border-0\">\n        \n```\n```{.python code-line-numbers=\"1\"}\nimport paho.mqtt.client as mqtt\nimport pandas as pd\nfrom datetime import datetime\n\n# MQTT broker details\nbroker_address = \"broker.hivemq.com\"\nbroker_port = 1883\n\n# Create a DataFrame to store the messages\ndf = pd.DataFrame(columns=[\"topic\", \"value\"])\n\n# Callback function when a connection is established with the MQTT broker\ndef on_connect(client, userdata, flags, rc):\n    print(\"Connected to MQTT broker with result code: \" + str(rc))\n    # Subscribe to all subtopics within agrotech/mqtt_tutorial/\n    client.subscribe(\"agrotech/mqtt_tutorial/#\")\n\n# Callback function when a message is received\ndef on_message(client, userdata, msg):\n    global df\n    # Decode the message payload\n    value = msg.payload.decode()\n    # Extract the subtopic\n    subtopic = msg.topic.split(\"agrotech/mqtt_tutorial/\")[1]\n    # Get the current time\n    timestamp = datetime.now()\n    # Create a new DataFrame with the new message\n    new_row = pd.DataFrame({\"topic\": [subtopic], \"value\": [value]}, index=[timestamp])\n    # Append the new row to the DataFrame using concat\n    df = pd.concat([df, new_row])\n    print(f\"Received message on {msg.topic}: {value}\")\n\n# Create an MQTT client instance\nclient = mqtt.Client()\n\n# Assign callback functions\nclient.on_connect = on_connect\nclient.on_message = on_message\n\n# Connect to the MQTT broker\nclient.connect(broker_address, broker_port, 60)\n\n# Loop to maintain the connection and process network traffic\ntry:\n    client.loop_forever()\nexcept KeyboardInterrupt:\n    # Save the DataFrame to a CSV file when the script is interrupted\n    df.to_csv(\"mqtt_messages.csv\")\n    print(\"Data saved to mqtt_messages.csv\")\n\n```\n\n```{=html}\n\n            </div>\n            </div>\n            \n```\n\n\n## Control irrigation solenoid in the greenhouse\n\nUse the code below to control the irrigation solenoid outside the greenhouse.\n\nCode usage: connect a jumper to A4. Whenever you touch the jumper, the solenoid will be open, otherwise it will be closed.\n\n```{=html}\n<button class=\"btn btn-outline-dark  rounded\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#mqtt_toggle_irrigationino\" aria-expanded=\"false\" aria-controls=\"mqtt_toggle_irrigationino\">\n    <i class=\"bi bi-toggles\"></i> Toggle code\n    </button>\n     <a class=\"btn btn-outline-dark rounded\", href=\"/archive/code/mqtt_toggle_irrigation.ino\" download target=\"_blank\" rel=\"noopener noreferrer\">\n        <i class=\"bi bi-download\"></i> Download code\n    </a>\n```\n```{=html}\n\n            <div class=\"collapse\" id=\"mqtt_toggle_irrigationino\">\n            <div class=\"card card-body border-0\">\n        \n```\n```{.c code-line-numbers=\"1\"}\n#include <WiFi.h>\n#include <PubSubClient.h>\n\n// WiFi credentials\nconst char* ssid = \"agrotech\";          // Replace with your WiFi SSID\nconst char* password = \"1Afuna2gezer\";  // Replace with your WiFi Password\n\n// MQTT broker details\nconst char* mqtt_server = \"192.168.0.102\";    // IP address of Home Assistant\nconst int mqtt_port = 1883;                   // Default MQTT port\nconst char* mqtt_user = \"mqtt-user\";          // MQTT username\nconst char* mqtt_password = \"1234\";           // MQTT password\nconst char* mqtt_topic = \"/greenhouse/outside/irrigation/solenoid5\"; // MQTT topic\n\n// Touch pin configuration\n#define TOUCH_PIN A4  // Use GPIO 4 as touch pin (T0 on ESP32)\n\n// MQTT client and WiFi client\nWiFiClient espClient;\nPubSubClient client(espClient);\n\n// State variable to track touch pin state\nbool send_message = false;\n\nvoid setup_wifi() {\n  Serial.print(\"Connecting to WiFi: \");\n  Serial.println(ssid);\n  WiFi.begin(ssid, password);\n\n  while (WiFi.status() != WL_CONNECTED) {\n    delay(500);\n    Serial.print(\".\");\n  }\n\n  Serial.println(\"\\nWiFi connected\");\n  Serial.print(\"IP address: \");\n  Serial.println(WiFi.localIP());\n}\n\nvoid reconnect() {\n  // Attempt to reconnect to the MQTT broker\n  while (!client.connected()) {\n    Serial.print(\"Attempting MQTT connection...\");\n    if (client.connect(\"ESP32Client\", mqtt_user, mqtt_password)) {\n      Serial.println(\"connected\");\n    } else {\n      Serial.print(\"failed, rc=\");\n      Serial.print(client.state());\n      Serial.println(\" Retrying in 5 seconds...\");\n      delay(5000);\n    }\n  }\n}\n\nvoid setup() {\n  Serial.begin(115200);\n\n  // Initialize WiFi\n  setup_wifi();\n\n  // Set up MQTT\n  client.setServer(mqtt_server, mqtt_port);\n\n  // Ensure the ESP32 starts connected to the MQTT broker\n  reconnect();\n}\n\nvoid loop() {\n  if (!client.connected()) {\n    reconnect();\n  }\n  client.loop();\n\n  // Read the state of the touch pin\n  bool is_touched = touchRead(TOUCH_PIN) < 40;  // If the value is less than 40, the pin is being touched\n\n  // Send \"1\" if the pin is being touched\n  if (is_touched) {\n    if (!send_message) {\n      client.publish(mqtt_topic, \"1\");\n      Serial.println(\"Sent: 1\");\n      send_message = true;  // Set flag to avoid sending multiple times while touching\n    }\n  } \n  // Send \"0\" if the pin is not being touched\n  else {\n    if (send_message) {\n      client.publish(mqtt_topic, \"0\");\n      Serial.println(\"Sent: 0\");\n      send_message = false;  // Reset the flag when pin is no longer touched\n    }\n  }\n\n  // Optional: Small delay to avoid flooding the MQTT server with messages\n  delay(100);  // Adjust the delay if necessary\n}\n\n```\n\n```{=html}\n\n            </div>\n            </div>\n            \n```\n\n\n",
    "supporting": [
      "MQTT_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}